<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>Document Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Clean Loading Screen */
        .loading-screen {
               display: flex;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              z-index: 9999;
        }

        .loading-container {
                margin-bottom: 30px;
                perspective: 1000px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 50px 40px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
                text-align: center;
                max-width: 400px;
                width: 90%;
                border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rotating-logo {
    font-size: 4rem;
    color: #3b82f6;
    animation: rotateY 2s ease-in-out infinite;
    transform-style: preserve-3d;
    display: inline-block;
    text-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}

@keyframes rotateY {
    0% { 
        transform: rotateY(0deg) scale(1);
        opacity: 1;
    }
    25% { 
        transform: rotateY(90deg) scale(1.1);
        opacity: 0.8;
    }
    50% { 
        transform: rotateY(180deg) scale(1);
        opacity: 1;
    }
    75% { 
        transform: rotateY(270deg) scale(1.1);
        opacity: 0.8;
    }
    100% { 
        transform: rotateY(360deg) scale(1);
        opacity: 1;
    }
}

.loading-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 12px;
    letter-spacing: -0.025em;
}

.loading-subtitle {
    color: #64748b;
    font-size: 0.95rem;
    margin: 0;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

        /* Dashboard Styles */
        .dashboard {
            display: none;
            background: #f8fafc;
            min-height: 100vh;
        }

        .dashboard.show {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Clean Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Enhanced Search Section with Hover Dropdown */
        .search-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .search-section h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* Enhanced Search Input with Hover Dropdown */
        .search-input-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .search-input:focus, .search-input:hover {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Enhanced Search Dropdown */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            margin-top: 4px;
            max-height: 400px;
            overflow: hidden;
        }

        .search-dropdown.show {
            display: block;
        }

        .search-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 500;
            color: #1e293b;
        }

        .search-dropdown-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #64748b;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .search-dropdown-close:hover {
            color: #1e293b;
        }

        .search-dropdown-content {
            max-height: 320px;
            overflow-y: auto;
        }

        .search-dropdown-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-dropdown-item:hover {
            background: #f8fafc;
        }

        .search-dropdown-item.highlighted {
            background: #eff6ff;
        }

        .dropdown-item-title {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item-number {
            display: inline-block;
            background: #e0f2fe;
            color: #0277bd;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: monospace;
        }

        .dropdown-item-type {
            display: inline-block;
            background: #f1f5f9;
            color: #475569;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .dropdown-item-type.inward {
            background: #dbeafe;
            color: #1e40af;
        }

        .dropdown-item-type.outward {
            background: #fef3c7;
            color: #92400e;
        }

        .dropdown-item-meta {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }

        .dropdown-item-status {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .dropdown-item-status.confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .dropdown-item-status.ready {
            background: #fef3c7;
            color: #92400e;
        }

        .dropdown-item-status.incomplete {
            background: #fecaca;
            color: #991b1b;
        }

        /* Pending notification */
        .pending-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .pending-notification.show {
            transform: translateY(0);
        }

        .pending-notification .close-notification {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .dashboard.with-notification {
            margin-top: 50px;
        }

        /* Status Cards */
        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .status-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .status-card h3 {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .status-card .number {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .status-card.pending-work .number {
            color: #f59e0b;
        }

        .status-card.confirmed .number {
            color: #3b82f6;
        }

        /* Clean Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e2e8f0;
        }

        .btn-secondary.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Clean Cards */
        .user-info, .quick-actions, .entries-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-info h2, .quick-actions h2, .entries-section h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* FIXED: Table View Styles */
        .entries-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        /* Table Controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .table-filter-group, .table-search-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-filter, .table-search {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .table-filter:focus, .table-search:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .table-stats {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Table Wrapper */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        /* FIXED: Complete Table Styling */
        .entries-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.875rem;
        }

        .entries-table th {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .entries-table th:hover {
            background: #f1f5f9;
        }

        .entries-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }

        .entries-table tr:hover {
            background: #f9fafb;
        }

        .entries-table tr.confirmed {
            background: #f0fdf4;
        }

        .entries-table tr.pending-work {
            background: #fefbf2;
        }

        .entries-table tr.incomplete {
            background: #fef2f2;
        }

        .entries-table tr.linked {
            border-left: 4px solid #3b82f6;
        }

        /* Table Cell Styles */
        .table-entry-type {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .table-entry-type.inward {
            background: #dbeafe;
            color: #1e40af;
        }

        .table-entry-type.outward {
            background: #fef3c7;
            color: #92400e;
        }

        .table-entry-status {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .table-entry-status.confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .table-entry-status.pending-work {
            background: #fef3c7;
            color: #92400e;
        }

        .table-entry-status.incomplete {
            background: #fecaca;
            color: #991b1b;
        }

        .table-entry-links {
            color: #3b82f6;
            font-weight: 500;
        }

        .table-actions {
            white-space: nowrap;
        }

        .table-actions .btn {
            margin-right: 4px;
            margin-bottom: 4px;
        }

        /* Truncate long text in table cells */
        .table-cell-subject, .table-cell-person {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-cell-datetime {
            min-width: 120px;
            font-family: monospace;
            font-size: 0.8rem;
        }

        /* Sort Indicators */
        .sort-indicator::after {
            content: ' ↕';
            color: #9ca3af;
            font-size: 0.75rem;
        }

        /* Entry Items (Card View) */
        .entry-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.2s;
            position: relative;
            background: white;
        }

        .entry-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .entry-item.confirmed {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .entry-item.linked {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .entry-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
            flex: 1;
        }

        .entry-number {
            display: inline-block;
            background: #e0f2fe;
            color: #0277bd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: monospace;
            margin-right: 8px;
        }

        .entry-badges {
            display: flex;
            gap: 8px;
        }

        .entry-type {
            background: #f1f5f9;
            color: #475569;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .entry-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .entry-status.confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .entry-status.pending-work {
            background: #fef3c7;
            color: #92400e;
        }

        .entry-status.incomplete {
            background: #fecaca;
            color: #991b1b;
        }

        .entry-status.linked {
            background: #dbeafe;
            color: #1e40af;
        }

        .entry-meta {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 8px;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .entry-links {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
        }

        .entry-links-title {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .linked-entry {
            display: inline-block;
            background: #f8fafc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #475569;
            border: 1px solid #e2e8f0;
            margin-right: 8px;
            margin-bottom: 4px;
        }

        /* Search Options */
        .search-options {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-type {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .search-results {
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            margin-bottom: 8px;
        }

        .search-result-item:hover {
            background: #f8fafc;
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-result-title {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }

        .search-result-meta {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 4px;
            line-height: 1;
        }

        .close-btn:hover {
            color: #1e293b;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-group label.required::after {
            content: ' *';
            color: #ef4444;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            background: #10b981;
        }

        .message.error {
            background: #ef4444;
        }

        .message.info {
            background: #3b82f6;
        }

        .message.warning {
            background: #f59e0b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .status-overview {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                justify-content: center;
            }

            .user-details {
                grid-template-columns: 1fr;
            }

            .entry-actions {
                justify-content: center;
            }

            .search-container {
                flex-direction: column;
            }

            .search-options {
                flex-wrap: wrap;
            }
            
            .search-input-container {
                min-width: unset;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .table-wrapper {
                font-size: 0.75rem;
            }

            .table-cell-subject, .table-cell-person {
                max-width: 150px;
            }
        }
        .linking-modal .modal-content {
            max-width: 800px;
        }

        .search-in-modal {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .search-in-modal h4 {
            margin-bottom: 12px;
            color: #1e293b;
            font-size: 1rem;
        }

        .linkable-entries {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .linkable-entry {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .linkable-entry:hover {
            background: #f8fafc;
        }

        .linkable-entry:last-child {
            border-bottom: none;
        }

        .linkable-entry.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .linkable-entry-title {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .linkable-entry-meta {
            font-size: 0.875rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Pending Work Notification -->
    <div id="pendingNotification" class="pending-notification">
        <div class="pending-notification-content">
            <span>⚠️ You have <strong id="pendingNotificationCount">0</strong> entries with pending physical work</span>
        </div>
        <button class="close-notification" onclick="closePendingNotification()">&times;</button>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-container">
            <div class="logo-container">
                <div class="rotating-logo">
                <img src="https://www.sssihl.edu.in/wp-content/uploads/2020/11/cropped-SSSIHL-Logo_Site_Title-150x150.png" alt="University Logo" class="logo-image">
                </div>
            </div>
            <h1 class="loading-title">Document Management System</h1>
            <p class="loading-subtitle" id="loadingMessage">Loading your dashboard...</p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <header class="header">
                <h1>📋 Document Management System</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshDashboard()">🔄 Refresh</button>
                    <button class="btn btn-warning" onclick="exit()">🚪 Exit</button>
                </div>
            </header>

            <section class="user-info">
                <h2>Sai Ram ! <span id="userEmail">User</span></h2>
                <div class="user-details">
                    <div>
                        <strong>Access Level:</strong> <span id="userRole">Loading...</span>
                    </div>
                    <div>
                        <strong>Session Started:</strong> <span id="sessionTime">Loading...</span>
                    </div>
                </div>
            </section>

            <!-- Enhanced Search Section with Hover Dropdown -->
            <section class="search-section">
                <h2>🔍 Search Entries</h2>
                <div class="search-container">
                    <div class="search-input-container">
                        <input type="text" id="mainSearchInput" class="search-input" 
                               placeholder="Search entries... Hover to see all entries" 
                               autocomplete="off" />
                        <div id="searchDropdown" class="search-dropdown">
                            <div class="search-dropdown-header">
                                <span>📋 All Entries</span>
                                <button class="search-dropdown-close" onclick="hideSearchDropdown()">&times;</button>
                            </div>
                            <div id="searchDropdownContent" class="search-dropdown-content">
                                <div class="search-dropdown-loading">Loading entries...</div>
                            </div>
                        </div>
                    </div>
                    <div class="search-options">
                        <select id="searchType" class="search-type">
                            <option value="all">All Entries</option>
                            <option value="inward">Inward Only</option>
                            <option value="outward">Outward Only</option>
                            <option value="linked-only">Linked Only</option>
                            <option value="no-links">No Links</option>
                            <option value="by-uuid">Search UUID</option>
                        </select>
                        <button class="btn btn-primary" onclick="performMainSearchEnhanced()">🔍 Search</button>
                        <button class="btn btn-secondary" onclick="showAllLinkedEntries()">🔗 All Linked</button>
                        <button class="btn btn-secondary" onclick="clearMainSearchEnhanced()">✖️ Clear</button>
                    </div>
                </div>
                <div id="mainSearchResults" class="search-results" style="display: none;"></div>
            </section>

            <!-- Status Overview -->
            <section class="status-overview">
                <div class="status-card pending-work">
                    <h3>📋 Pending Work</h3>
                    <div class="number" id="readyCount">-</div>
                    <p style="font-size: 0.75rem; color: #64748b; margin-top: 4px;">Entries awaiting physical action</p>
                </div>
                <div class="status-card confirmed">
                    <h3>✅ Work Completed</h3>
                    <div class="number" id="confirmedCount">-</div>
                    <p style="font-size: 0.75rem; color: #64748b; margin-top: 4px;">Physically processed entries</p>
                </div>
            </section>

            <section class="quick-actions">
                <h2>📝 Quick Actions</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" type="button" onclick="showNewEntryForm('Inward')">+ NEW INWARD</button>
                    <button class="btn btn-primary" type="button" onclick="showNewEntryForm('Outward')">+ NEW OUTWARD</button>
                    <button class="btn btn-secondary" type="button" onclick="showFinancialReportModal()">💰 FINANCIAL REPORT</button>
                </div>
            </section>  

            <section class="entries-section">
                <!-- FIXED: Added proper entries section header with view toggle -->
                <div class="entries-section-header">
                    <h2 id="entriesHeader">📋 Recent Entries</h2>
                    <div class="view-toggle">
                        <button class="btn btn-secondary btn-sm active" id="cardViewBtn" onclick="switchToCardView()">📱 Card View</button>
                        <button class="btn btn-secondary btn-sm" id="tableViewBtn" onclick="switchToTableView()">📊 Table View</button>
                    </div>
                </div>
                
                <!-- Card View (existing) -->
                <div id="entriesContainer">
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        Loading entries...
                    </div>
                </div>
                
                <!-- FIXED: Complete Table View Implementation -->
                <div id="tableViewContainer" style="display: none;">
                    <div class="table-controls">
                        <div class="table-filter-group">
                            <label for="tableFilterType" style="font-size: 0.875rem; margin-right: 8px;">Filter:</label>
                            <select id="tableFilterType" class="table-filter" onchange="filterTable()">
                                <option value="all">All Entries</option>
                                <option value="inward">Inward Only</option>
                                <option value="outward">Outward Only</option>
                                <option value="confirmed">Confirmed Only</option>
                                <option value="pending">Pending Work</option>
                                <option value="incomplete">Incomplete</option>
                                <option value="linked">With Links</option>
                            </select>
                        </div>
                        <div class="table-search-group">
                            <label for="tableSearchInput" style="font-size: 0.875rem; margin-right: 8px;">Search:</label>
                            <input type="text" id="tableSearchInput" class="table-search" placeholder="Search in table..." onkeyup="searchTable()" style="width: 200px;">
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="exportTableData()">💾 Export CSV</button>
                        <div class="table-stats" id="tableStats" style="font-size: 0.875rem; color: #64748b; margin-left: auto;">
                            <!-- Stats will be populated here -->
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table id="entriesTable" class="entries-table">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)" style="cursor: pointer;">Type <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(1)" style="cursor: pointer;">Number <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(2)" style="cursor: pointer;">Subject <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(3)" style="cursor: pointer;">Person <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(4)" style="cursor: pointer;">Date/Time <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(5)" style="cursor: pointer;">Means <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(6)" style="cursor: pointer;">User <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(7)" style="cursor: pointer;">Status <span class="sort-indicator"></span></th>
                                    <th onclick="sortTable(8)" style="cursor: pointer;">Links <span class="sort-indicator"></span></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="entriesTableBody">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                                        Loading entries...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Entry Form Modal (for NEW entries) -->
<div id="entryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle" class="modal-title">📥 New Entry</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="entryForm">
            <input type="hidden" id="entryTypeField" name="entryType">
            
            <div class="form-group">
                <label for="receiptDateTime" class="required">Date & Time</label>
                <input type="datetime-local" id="receiptDateTime" name="receiptDateTime" required>
            </div>
            
            <div class="form-group">
                <label for="means" class="required">Means</label>
                <select id="means" name="means" required>
                    <option value="" disabled selected style="color: #999;">Select communication method</option>
                    <option value="Post">Post</option>
                    <option value="Direct">Direct</option>
                    <option value="Email">Email</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="subject" class="required">Subject</label>
                <input type="text" id="subject" name="subject" required placeholder="Enter subject/title">
            </div>

            <!-- Inward specific fields -->
            <div class="form-group" id="inwardNoGroup">
                <label for="inwardNo">Inward No (Auto-Generated)</label>
                <input type="text" id="inwardNo" name="inwardNo" placeholder="Will be auto-generated: INW/2025/XXX" readonly style="background-color: #f8fafc; color: #64748b;">
            </div>
            <div class="form-group" id="fromWhomGroup">
                <label for="fromWhom" class="required">From Whom</label>
                <input type="text" id="fromWhom" name="fromWhom" placeholder="Enter sender details">
            </div>
            <div class="form-group" id="takenByGroup">
                <label for="takenBy" class="required">Taken By</label>
                <input type="text" id="takenBy" name="takenBy" placeholder="Enter your name" required>
            </div>
            <div class="form-group" id="actionTakenGroup">
                <label for="actionTaken">Action Taken</label>
                <textarea id="actionTaken" name="actionTaken" placeholder="Describe action taken"></textarea>
                <div style="font-size: 0.75rem; color: #64748b; margin-top: 4px;">
                    Note: Entry can be created without action taken, but Complete button will be disabled until this is filled.
                </div>
            </div>
            
            <!-- Outward specific fields -->
            <div class="form-group" id="outwardNoGroup" style="display: none;">
            <label for="outwardNo">Outward No (Auto-Generated)</label>
            <input type="text" id="outwardNo" name="outwardNo" placeholder="Will be auto-generated: OTW/2025/XXX" readonly style="background-color: #f8fafc; color: #64748b;">
        </div>
        <div class="form-group" id="toWhomGroup" style="display: none;">
            <label for="toWhom" class="required">To Whom</label>
            <input type="text" id="toWhom" name="toWhom" placeholder="Enter recipient details" required>
        </div>
        <div class="form-group" id="sentByGroup" style="display: none;">
            <label for="sentBy" class="required">Sent By</label>
            <input type="text" id="sentBy" name="sentBy" placeholder="Enter your name" required>
        </div>
        <div class="form-group" id="caseClosedGroup" style="display: none;">
            <label for="caseClosed" class="required">Case Closed</label>
            <select id="caseClosed" name="caseClosed" required>
                <option value="">Select status</option>
                <option value="No">No</option>
                <option value="Yes">Yes</option>
            </select>
        </div>

        <div class="form-group" id="dueDateGroup" style="display: none;">
            <label for="dueDate" class="required">Due Date</label>
            <input type="date" id="dueDate" name="dueDate" placeholder="Select due date" required>
        </div>

            <!-- Common fields -->
            <div class="form-group">
                <label for="fileReference" id="fileRefLabel">File Reference</label>
                <input type="text" id="fileReference" name="fileReference" placeholder="Enter file reference">
            </div>
            <div class="form-group">
                <label for="postalTariff" id="postalTariffLabel">Postal Tariff</label>
                <input type="number" id="postalTariff" name="postalTariff" step="0.01" placeholder="Enter amount">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Create Entry</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Entry Modal (SEPARATE MODAL - moved outside) -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="editModalTitle" class="modal-title">✏️ Edit Entry</h3>
            <button class="close-btn" onclick="closeEditModal()">&times;</button>
        </div>
        
        <form id="editEntryForm">
            <input type="hidden" id="editEntryId" name="editEntryId">
            <input type="hidden" id="editEntryType" name="editEntryType">
            
            <div class="form-group">
                <label for="editReceiptDateTime" class="required">Date & Time</label>
                <input type="datetime-local" id="editReceiptDateTime" name="receiptDateTime" required>
            </div>
            
            <div class="form-group">
                <label for="editMeans" class="required">Means</label>
                <select id="editMeans" name="means" required>
                    <option value="">Select communication method</option>
                    <option value="Post">Post</option>
                    <option value="Direct">Direct</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editSubject" class="required">Subject</label>
                <input type="text" id="editSubject" name="subject" required placeholder="Enter subject/title">
            </div>

            <!-- Inward specific fields -->
            <div class="form-group" id="editInwardNoGroup">
                <label for="editInwardNo">Inward No</label>
                <input type="text" id="editInwardNo" name="inwardNo" readonly style="background-color: #f8fafc; color: #64748b;">
            </div>
            <div class="form-group" id="editFromWhomGroup">
                <label for="editFromWhom" class="required">From Whom</label>
                <input type="text" id="editFromWhom" name="fromWhom" placeholder="Enter sender details">
            </div>
            <div class="form-group" id="editTakenByGroup">
                <label for="editTakenBy" class="required">Taken By</label>
                <input type="text" id="editTakenBy" name="takenBy" placeholder="Enter your name" required>
            </div>
            <div class="form-group" id="editActionTakenGroup">
                <label for="editActionTaken">Action Taken</label>
                <textarea id="editActionTaken" name="actionTaken" placeholder="Describe action taken"></textarea>
            </div>
            
            <!-- Outward specific fields -->
            <div class="form-group" id="editOutwardNoGroup" style="display: none;">
                <label for="editOutwardNo">Outward No</label>
                <input type="text" id="editOutwardNo" name="outwardNo" readonly style="background-color: #f8fafc; color: #64748b;">
            </div>
            <div class="form-group" id="editToWhomGroup" style="display: none;">
                <label for="editToWhom" class="required">To Whom</label>
                <input type="text" id="editToWhom" name="toWhom" placeholder="Enter recipient details">
            </div>
            <div class="form-group" id="editSentByGroup" style="display: none;">
                <label for="editSentBy" class="required">Sent By</label>
                <input type="text" id="editSentBy" name="sentBy" placeholder="Enter your name">
            </div>
            <div class="form-group" id="editCaseClosedGroup" style="display: none;">
                <label for="editCaseClosed" class="required">Case Closed</label>
                <select id="editCaseClosed" name="caseClosed" required>
                    <option value="">Select status</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
            </div>
            <div class="form-group" id="editDueDateGroup" style="display: none;">
                <label for="editDueDate" class="required">Due Date</label>
                <input type="date" id="editDueDate" name="dueDate" required>
            </div>

            <!-- Common fields -->
            <div class="form-group">
                <label for="editFileReference" id="editFileRefLabel">File Reference</label>
                <input type="text" id="editFileReference" name="fileReference" placeholder="Enter file reference">
            </div>
            <div class="form-group">
                <label for="editPostalTariff" id="editPostalTariffLabel">Postal Tariff</label>
                <input type="number" id="editPostalTariff" name="postalTariff" step="0.01" placeholder="Enter amount">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="updateBtn">Update Entry</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">✅ Mark Work as Complete</h3>
            <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
        </div>
        
        <div id="confirmEntryDetails">
            <!-- Entry details will be populated here -->
        </div>
        
        <div style="background: #eff6ff; padding: 12px; border-radius: 6px; border-left: 4px solid #3b82f6; margin: 16px 0;">
            <p style="color: #1e40af; font-size: 0.875rem; margin: 0;">
                <strong>💡 Note:</strong> Click "Mark as Complete" only after you have finished the physical work or processing related to this entry.
            </p>
        </div>
        
        <div class="form-group">
            <label for="confirmationNote">Work Completion Notes (Optional)</label>
            <textarea id="confirmationNote" placeholder="Add any notes about the work completed..."></textarea>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
            <button type="button" class="btn btn-success" id="confirmBtn" onclick="confirmEntry()">✅ Mark as Complete</button>
        </div>
    </div>
</div>

<!-- Linking Modal -->
<div id="linkingModal" class="modal linking-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">🔗 Link Entries</h3>
            <button class="close-btn" onclick="closeLinkingModal()">&times;</button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <h4 style="color: #1e293b; margin-bottom: 8px;">Current Entry:</h4>
            <div id="currentEntryForLinking" style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <!-- Current entry details -->
            </div>
        </div>

        <!-- Search within modal -->
        <div class="search-in-modal">
            <h4>🔍 Search for entries to link:</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <input type="text" id="linkingSearchInput" class="search-input" placeholder="Search entries to link..." style="flex: 1;" />
                <select id="linkingSearchType" class="search-type">
                    <option value="all">All</option>
                    <option value="inward">Inward</option>
                    <option value="outward">Outward</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="searchInLinkingModal()">Search</button>
                <button class="btn btn-secondary btn-sm" onclick="clearLinkingSearch()">Clear</button>
            </div>
        </div>
        
        <div>
            <h4 style="color: #1e293b; margin-bottom: 8px;">Available entries:</h4>
            <div id="linkableEntries" class="linkable-entries">
                <div style="text-align: center; padding: 20px; color: #64748b;">
                    Loading available entries...
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeLinkingModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="linkEntriesBtn" onclick="linkSelectedEntries()">🔗 Link Entries</button>
        </div>
    </div>
</div>

    <!-- Additional modals would go here... -->

    <script>
        let currentUser = null;
        let isAdmin = false;
        let sessionStartTime = new Date();
        let currentEntries = [];
        let filteredTableEntries = [];
        let currentTableSort = { column: -1, direction: 'asc' };
        let currentView = 'card'; // 'card' or 'table'
        let selectedEntryForConfirmation = null;
        let selectedEntryForLinking = null;
        let selectedEntriesForLinking = [];
        let currentLinkableEntries = [];
        let allLinkableEntries = [];
        
        // Enhanced dropdown variables
        let searchDropdownEntries = [];
        let filteredDropdownEntries = [];
        let dropdownVisible = false;
        let selectedDropdownIndex = -1;
        let hoverTimeout = null;

        // FIXED: Ensure DOM is ready before initializing
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing Document Management System...');
            
            // Small delay to ensure Google Apps Script is ready
            setTimeout(() => {
                initializeApp();
                setupSearchDropdownEvents();
            }, 100);
        });

        // FIXED: Enhanced initialization with better error handling
        function initializeApp() {
            console.log('Starting app initialization...');
            showLoadingScreen();
            
            // Check if Google Apps Script is available
            if (typeof google === 'undefined' || !google.script) {
                console.error('Google Apps Script not available');
                showMessage('Google Apps Script not available. Please ensure this is running in Google Apps Script environment.', 'error');
                
                // For testing purposes, show dashboard with dummy data
                currentUser = 'test@example.com';
                isAdmin = false;
                updateUserInfo();
                updateDashboardStats({ pending: 0, confirmed: 0 });
                showDashboard();
                return;
            }
            
            try {
                google.script.run
                    .withSuccessHandler(onInitialDataSuccess)
                    .withFailureHandler(onInitialDataError)
                    .getInitialData();
            } catch (error) {
                console.error('Error calling getInitialData:', error);
                onInitialDataError('Failed to connect to Google Apps Script: ' + error.toString());
            }
        }

        function onInitialDataSuccess(response) {
            console.log('Initial data response:', response);

            if (response && response.success) {
                currentUser = response.user.email;
                isAdmin = response.user.isAdmin;

                updateUserInfo();
                updateDashboardStats(response.stats);
                
                // Show pending work notification if there are pending entries
                if (response.stats && response.stats.pending > 0) {
                    showPendingWorkNotification(response.stats.pending);
                }
                
                loadEntries();
                showDashboard();
                showMessage('Welcome to the Document Management System!', 'success');
            } else {
                onInitialDataError(response ? response.message : 'Unknown server error');
            }
        }

        function onInitialDataError(error) {
            console.error('Failed to load initial data:', error);
            showMessage('Error loading application: ' + error.toString(), 'error');
            
            // Set default values
            document.getElementById('readyCount').textContent = '0';
            document.getElementById('confirmedCount').textContent = '0';
            
            // Show dashboard anyway for debugging
            showDashboard();
        }

        function updateUserInfo() {
            document.getElementById('userEmail').textContent = currentUser;
            document.getElementById('userRole').textContent = isAdmin ? 'Administrator' : 'User';
            document.getElementById('sessionTime').textContent = sessionStartTime.toLocaleString();
        }

        function updateDashboardStats(stats) {
            if (stats) {
                document.getElementById('readyCount').textContent = stats.pending || 0;
                document.getElementById('confirmedCount').textContent = stats.confirmed || 0;
            }
        }

        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('show');
        }

        function showDashboard() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('show');
        }

        // FIXED: Enhanced entry form handling
        function showNewEntryForm(entryType) {
    console.log(`Opening ${entryType} entry form...`);
    
    // Check if modal exists
    const modal = document.getElementById('entryModal');
    if (!modal) {
        console.error('Entry modal not found in DOM');
        showMessage('Error: Entry form not available', 'error');
        return;
    }
    
    const modalTitle = document.getElementById('modalTitle');
    if (!modalTitle) {
        console.error('Modal title element not found');
        showMessage('Error: Modal title not found', 'error');
        return;
    }
    
    // Set modal title and entry type
    modalTitle.textContent = entryType === 'Inward' ? '📥 New Inward Entry' : '📤 New Outward Entry';
    
    const entryTypeField = document.getElementById('entryTypeField');
    if (entryTypeField) {
        entryTypeField.value = entryType;
    }
    
    // Show/hide appropriate form fields
    toggleFormFields(entryType);
    
    // Reset and setup form
    resetEntryForm();
    
    // Set current date/time
    setCurrentDateTime();
    
    // Show modal
    modal.style.display = 'flex';
    
    // Setup form submission
    setupFormSubmission();
    
    console.log(`${entryType} form modal should now be visible`);
}

function toggleFormFields(entryType) {
    const inwardFields = ['inwardNoGroup', 'fromWhomGroup', 'takenByGroup', 'actionTakenGroup'];
    const outwardFields = ['outwardNoGroup', 'toWhomGroup', 'sentByGroup', 'caseClosedGroup', 'dueDateGroup'];
    
    // Get label elements for conditional required marking
    const fileRefLabel = document.getElementById('fileRefLabel');
    const postalTariffLabel = document.getElementById('postalTariffLabel');
    
    if (entryType === 'Inward') {
        // Show inward fields
        inwardFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'block';
        });
        
        // Hide outward fields
        outwardFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
        
        // Set required attributes for Inward
        setFieldRequired('fromWhom', true);
        setFieldRequired('takenBy', true);
        setFieldRequired('toWhom', false);
        setFieldRequired('sentBy', false);
        setFieldRequired('caseClosed', false);
        setFieldRequired('dueDate', false);
        setFieldRequired('fileReference', false);
        setFieldRequired('postalTariff', false);
        
        // Update labels
        if (fileRefLabel) {
            fileRefLabel.innerHTML = 'File Reference';
            fileRefLabel.classList.remove('required');
        }
        if (postalTariffLabel) {
            postalTariffLabel.innerHTML = 'Postal Tariff';
            postalTariffLabel.classList.remove('required');
        }
        
    } else {
        // Hide inward fields
        inwardFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
        
        // Show outward fields
        outwardFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'block';
        });
        
        // Set required attributes for Outward - ALL fields mandatory
        setFieldRequired('fromWhom', false);
        setFieldRequired('takenBy', false);
        setFieldRequired('toWhom', true);
        setFieldRequired('sentBy', true);
        setFieldRequired('caseClosed', true);
        setFieldRequired('dueDate', true);
        setFieldRequired('fileReference', true);
        setFieldRequired('postalTariff', true);
        
        // Update labels to show required
        if (fileRefLabel) {
            fileRefLabel.innerHTML = 'File Reference';
            fileRefLabel.classList.add('required');
        }
        if (postalTariffLabel) {
            postalTariffLabel.innerHTML = 'Postal Tariff';
            postalTariffLabel.classList.add('required');
        }
    }
}

function setFieldRequired(fieldId, isRequired) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.required = isRequired;
    }
}

function resetEntryForm() {
    const form = document.getElementById('entryForm');
    if (form) {
        form.reset();
        
        // Reset the entry type field after form reset
        const entryTypeField = document.getElementById('entryTypeField');
        if (entryTypeField) {
            // Will be set again by calling function
        }
    }
}

function setCurrentDateTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const dateTimeField = document.getElementById('receiptDateTime');
    if (dateTimeField) {
        dateTimeField.value = now.toISOString().slice(0,16);
    }
}

        function loadNextAvailableCodes(entryType) {
            if (typeof google === 'undefined' || !google.script) {
                console.log('Google Apps Script not available for code generation');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success) {
                        if (entryType === 'Inward') {
                            const inwardField = document.getElementById('inwardNo');
                            if (inwardField) {
                                inwardField.placeholder = `Will be auto-generated: ${result.inward.code}`;
                            }
                        } else {
                            const outwardField = document.getElementById('outwardNo');
                            if (outwardField) {
                                outwardField.placeholder = `Will be auto-generated: ${result.outward.code}`;
                            }
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading next codes:', error);
                    const currentYear = new Date().getFullYear();
                    if (entryType === 'Inward') {
                        const inwardField = document.getElementById('inwardNo');
                        if (inwardField) {
                            inwardField.placeholder = `Will be auto-generated: INW/${currentYear}/XXX`;
                        }
                    } else {
                        const outwardField = document.getElementById('outwardNo');
                        if (outwardField) {
                            outwardField.placeholder = `Will be auto-generated: OTW/${currentYear}/XXX`;
                        }
                    }
                })
                .getNextAvailableCodes();
        }

        function setupFormSubmission() {
          const form = document.getElementById('entryForm');
          if (form) {
              // Remove any existing event listeners
              form.onsubmit = null;
              
              // Add new event listener
              form.addEventListener('submit', function(e) {
                  e.preventDefault();
                  console.log('Form submitted via event listener');
                  submitNewEntry();
              });
              
              // Also set onsubmit as backup
              form.onsubmit = function(e) {
                  e.preventDefault();
                  console.log('Form submitted via onsubmit');
                  submitNewEntry();
                  return false;
              };
          }
          
          // Also add click handler to submit button as backup
          const submitBtn = document.getElementById('submitBtn');
          if (submitBtn) {
              submitBtn.onclick = function(e) {
                  e.preventDefault();
                  console.log('Submit button clicked');
                  submitNewEntry();
              };
          }
      }

        function submitNewEntry() {
        console.log('Submitting new entry...');
        
        // Check if Google Apps Script is available
        if (typeof google === 'undefined' || !google.script) {
            showMessage('Google Apps Script not available. Cannot submit entry.', 'error');
            return;
        }
        
        const form = document.getElementById('entryForm');
        if (!form) {
            showMessage('Form not found', 'error');
            return;
        }
        
        // Get form data manually to ensure all fields are captured
        const entryType = document.getElementById('entryTypeField').value;
        
        if (!entryType) {
            showMessage('Entry type not specified', 'error');
            return;
        }
        
        // Collect form data
        const entryData = {
            receiptDateTime: document.getElementById('receiptDateTime').value,
            means: document.getElementById('means').value,
            subject: document.getElementById('subject').value,
            fileReference: document.getElementById('fileReference').value,
            postalTariff: document.getElementById('postalTariff').value
        };
        
        // Add type-specific fields
        if (entryType === 'Inward') {
            entryData.fromWhom = document.getElementById('fromWhom').value;
            entryData.takenBy = document.getElementById('takenBy').value;
            entryData.actionTaken = document.getElementById('actionTaken').value;
        } else {
            entryData.toWhom = document.getElementById('toWhom').value;
            entryData.sentBy = document.getElementById('sentBy').value;
            entryData.caseClosed = document.getElementById('caseClosed').value;
            entryData.dueDate = document.getElementById('dueDate').value;
        }
        
        // Validate required fields
        const validation = validateFormData(entryData, entryType);
        if (!validation.isValid) {
            showMessage(validation.message, 'error');
            return;
        }
        
        console.log('Form data collected:', entryData);
        
        const submitBtn = document.getElementById('submitBtn');
        if (!submitBtn) {
            showMessage('Submit button not found', 'error');
            return;
        }
        
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating...';
        submitBtn.disabled = true;
        
        google.script.run
            .withSuccessHandler(function(result) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                console.log('Backend response:', result);
                
                if (result && result.success) {
                    const codeInfo = result.generatedCode ? ` (Code: ${result.generatedCode})` : '';
                    showMessage(`${entryType} entry created successfully!${codeInfo}`, 'success');
                    closeModal();
                    setTimeout(() => refreshDashboard(), 1000);
                } else {
                    showMessage('Error creating entry: ' + (result ? result.message : 'Unknown error'), 'error');
                }
            })
            .withFailureHandler(function(error) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                console.error('Backend error:', error);
                showMessage('Error creating entry: ' + error.toString(), 'error');
            })
            .createNewEntry(entryType, entryData);
            }

        function validateFormData(entryData, entryType) {
            // Check basic required fields
            if (!entryData.receiptDateTime || !entryData.means || !entryData.subject) {
                return { isValid: false, message: 'Date/Time, Means, and Subject are required' };
            }
            
            // Check entry-type specific fields
            if (entryType === 'Inward') {
                if (!entryData.fromWhom) {
                    return { isValid: false, message: 'From Whom field is required for inward entries' };
                }
                if (!entryData.takenBy) {
                    return { isValid: false, message: 'Taken By field is required for inward entries' };
                }
            }
            
            if (entryType === 'Outward') {
                if (!entryData.toWhom) {
                    return { isValid: false, message: 'To Whom field is required for outward entries' };
                }
                if (!entryData.sentBy) {
                    return { isValid: false, message: 'Sent By field is required for outward entries' };
                }
            }
            
            return { isValid: true };
        }

        // FIXED: Table view functions with complete implementation
        function switchToCardView() {
            currentView = 'card';
            document.getElementById('entriesContainer').style.display = 'block';
            document.getElementById('tableViewContainer').style.display = 'none';
            
            // Update button states
            const cardBtn = document.getElementById('cardViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');
            
            if (cardBtn) cardBtn.classList.add('active');
            if (tableBtn) tableBtn.classList.remove('active');
            
            // Update header
            const header = document.getElementById('entriesHeader');
            if (header) {
                header.textContent = `📋 Recent Entries (${currentEntries.length})`;
            }
        }

        function switchToTableView() {
            currentView = 'table';
            document.getElementById('entriesContainer').style.display = 'none';
            document.getElementById('tableViewContainer').style.display = 'block';
            
            // Update button states
            const cardBtn = document.getElementById('cardViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');
            
            if (cardBtn) cardBtn.classList.remove('active');
            if (tableBtn) tableBtn.classList.add('active');
            
            // Update header and populate table
            const header = document.getElementById('entriesHeader');
            if (header) {
                header.textContent = `📊 Table View (${currentEntries.length})`;
            }
            
            populateTable(currentEntries);
        }

        function populateTable(entries) {
            const tableBody = document.getElementById('entriesTableBody');
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }
            
            if (!entries || entries.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                            No entries to display
                        </td>
                    </tr>
                `;
                updateTableStats(0, 0);
                return;
            }
            
            filteredTableEntries = [...entries];
            
            const tableHtml = entries.map(entry => {
                // Determine status
                let statusClass = 'incomplete';
                let statusText = 'Incomplete';
                let rowClass = '';
                
                if (entry.confirmed) {
                      statusClass = 'confirmed';
                      statusText = 'Work Complete';
                      rowClass = 'confirmed';
                  } else if (entry.complete) {
                    if (entry.type === 'Inward') {
                        if (!entry.actionTaken) {
                            statusClass = 'pending-work';
                            statusText = 'Work Pending';
                            rowClass = 'pending-work';
                        } else {
                            statusClass = 'confirmed';
                            statusText = 'Work Completed';
                            rowClass = 'confirmed';
                        }
                    } else {
                        // For Outward entries
                        statusClass = 'pending-work';
                        statusText = 'Work Pending';
                        rowClass = 'pending-work';
                    }
                } else {
                    statusClass = 'incomplete';
                    statusText = 'Incomplete Data';
                    rowClass = 'incomplete';
                }
                
                if (entry.linkedEntries && entry.linkedEntries.length > 0) {
                    rowClass += ' linked';
                }
                
                const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
                const linksDisplay = entry.linkedEntries && entry.linkedEntries.length > 0 
                    ? `<span class="table-entry-links">🔗 ${entry.linkedEntries.length}</span>`
                    : '<span style="color: #9ca3af;">None</span>';
                
                const actionButtons = createTableActionButtons(entry);
                
                return `
                    <tr class="${rowClass}" data-entry-id="${entry.id}">
                        <td><span class="table-entry-type ${entry.type.toLowerCase()}">${entry.type}</span></td>
                        <td style="font-family: monospace;">${entryNumber}</td>
                        <td class="table-cell-subject" title="${entry.subject || 'No Subject'}">${entry.subject || 'No Subject'}</td>
                        <td class="table-cell-person" title="${entry.person || 'Unknown'}">${entry.person || 'Unknown'}</td>
                        <td class="table-cell-datetime">${entry.dateTime || 'Unknown'}</td>
                        <td>${entry.means || 'Unknown'}</td>
                        <td title="${entry.user || 'Unknown'}">${entry.user || 'Unknown'}</td>
                        <td><span class="table-entry-status ${statusClass}">${statusText}</span></td>
                        <td>${linksDisplay}</td>
                        <td class="table-actions">${actionButtons}</td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = tableHtml;
            updateTableStats(entries.length, entries.length);
        }

        function createTableActionButtons(entry) {
            let buttons = [];
            
            // Complete button logic
            if (!entry.confirmed && entry.complete) {
                if (entry.type === 'Outward' || (entry.type === 'Inward' && entry.actionTaken)) {
                    buttons.push(`<button class="btn btn-success btn-sm" onclick="showConfirmModal('${entry.id}')" title="Mark as Complete">✅</button>`);
                }
            }
            
            // Edit button
            if (!entry.complete || (entry.type === 'Inward' && !entry.actionTaken)) {
                buttons.push(`<button class="btn btn-warning btn-sm" onclick="editEntry('${entry.id}')" title="Complete Data">✏️</button>`);
            }
            
            // Link button
            buttons.push(`<button class="btn btn-primary btn-sm" onclick="showLinkingModal('${entry.id}')" title="Link Entry">🔗</button>`);
            
            // View button
            buttons.push(`<button class="btn btn-secondary btn-sm" onclick="viewEntryDetails('${entry.id}')" title="View Details">👁️</button>`);
            
            return buttons.join(' ');
        }

        function filterTable() {
    const filterType = document.getElementById('tableFilterType').value;
    const searchQuery = document.getElementById('tableSearchInput').value.toLowerCase().trim();
    
    let filtered = [...currentEntries];
    
    // Apply type filter
    switch(filterType) {
        case 'inward':
            filtered = filtered.filter(entry => entry.type === 'Inward');
            break;
        case 'outward':
            filtered = filtered.filter(entry => entry.type === 'Outward');
            break;
        case 'confirmed':
            filtered = filtered.filter(entry => entry.confirmed);
            break;
        case 'pending':
            filtered = filtered.filter(entry => {
                if (entry.type === 'Inward') {
                    return entry.complete && entry.actionTaken && !entry.confirmed;
                } else {
                    return entry.complete && !entry.confirmed;
                }
            });
            break;
        case 'incomplete':
            filtered = filtered.filter(entry => {
                if (entry.type === 'Inward') {
                    return !entry.complete || !entry.actionTaken;
                } else {
                    return !entry.complete;
                }
            });
            break;
        case 'linked':
            filtered = filtered.filter(entry => entry.linkedEntries && entry.linkedEntries.length > 0);
            break;
    }
    
    // Apply search filter
    if (searchQuery) {
        filtered = filtered.filter(entry => {
            const searchableText = [
                entry.subject || '',
                entry.person || '',
                entry.user || '',
                entry.means || '',
                entry.fileReference || '',
                entry.inwardNo || entry.outwardNo || '',
                entry.actionTaken || entry.caseClosed || ''
            ].join(' ').toLowerCase();
            
            return searchableText.includes(searchQuery);
        });
    }
    
    filteredTableEntries = filtered;
    populateTable(filtered);
    updateTableStats(filtered.length, currentEntries.length);
}

function searchTable() {
    filterTable(); // Reuse the filter function since it handles search too
}

function exportTableData() {
    const dataToExport = filteredTableEntries.length > 0 ? filteredTableEntries : currentEntries;
    
    if (dataToExport.length === 0) {
        showMessage('No data to export', 'warning');
        return;
    }
    
    // Create CSV content
    const headers = ['Type', 'Number', 'Subject', 'Person', 'Date/Time', 'Means', 'User', 'Status', 'Links', 'File Reference'];
    const csvContent = [
        headers.join(','),
        ...dataToExport.map(entry => {
            const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
            let status = 'Incomplete';
            if (entry.confirmed) {
                status = 'Work Complete';
            } else if (entry.complete) {
                if (entry.type === 'Inward' && !entry.actionTaken) {
                    status = 'Action Required';
                } else {
                    status = 'Work Pending';
                }
            }
            
            const linksCount = entry.linkedEntries ? entry.linkedEntries.length : 0;
            
            return [
                entry.type || '',
                entryNumber,
                `"${(entry.subject || '').replace(/"/g, '""')}"`,
                `"${(entry.person || '').replace(/"/g, '""')}"`,
                entry.dateTime || '',
                entry.means || '',
                entry.user || '',
                status,
                linksCount,
                `"${(entry.fileReference || '').replace(/"/g, '""')}"`
            ].join(',');
        })
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `entries_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage(`Exported ${dataToExport.length} entries to CSV`, 'success');
}

        

        function updateTableStats(showing, total) {
            const statsElement = document.getElementById('tableStats');
            if (statsElement) {
                if (showing === total) {
                    statsElement.textContent = `Showing ${total} entries`;
                } else {
                    statsElement.textContent = `Showing ${showing} of ${total} entries`;
                }
            }
        }

        function exportTableData() {
            console.log('Export table data functionality');
            showMessage('Export functionality coming soon', 'info');
        }

        // Load entries function
        function loadEntries() {
            if (typeof google === 'undefined' || !google.script) {
                console.log('Google Apps Script not available - using dummy data');
                currentEntries = [];
                displayEntriesInCurrentView([]);
                return;
            }
            
            google.script.run
                .withSuccessHandler(onEntriesLoaded)
                .withFailureHandler(onEntriesError)
                .getEntriesWithDetails();
        }

        function onEntriesLoaded(result) {
            console.log('Entries loaded:', result);
            
            if (result && result.success) {
                currentEntries = result.entries || [];
                displayEntriesInCurrentView(currentEntries);
                
                if (result.stats) {
                    updateDashboardStats(result.stats);
                }
            } else {
                onEntriesError(result ? result.message : 'Failed to load entries');
            }
        }

        function onEntriesError(error) {
            console.error('Entries loading error:', error);
            const container = document.getElementById('entriesContainer');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>Error loading entries. Please try refreshing.</p>
                        <button class="btn btn-primary" onclick="loadEntries()" style="margin-top: 10px;">
                            🔄 Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayEntriesInCurrentView(entries) {
            if (currentView === 'card') {
                displayEntriesAsCards(entries);
            } else {
                populateTable(entries);
            }
        }

        function displayEntriesAsCards(entries) {
            const container = document.getElementById('entriesContainer');
            if (!container) return;
            
            if (!entries || entries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>✅ No entries found. Start by creating your first entry!</p>
                        <p style="margin-top: 10px;">Click "NEW INWARD" or "NEW OUTWARD" to get started.</p>
                    </div>
                `;
                return;
            }
            
            const entriesHtml = entries.map(entry => {
                const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
                
                let statusClass = 'incomplete';
                let statusText = 'Incomplete';
                let entryClass = '';
                
                if (entry.confirmed) {
                    statusClass = 'confirmed';
                    statusText = 'Work Complete';
                    entryClass = 'confirmed';
                } else if (entry.complete) {
                    if (entry.type === 'Inward' && !entry.actionTaken) {
                        statusClass = 'incomplete';
                        statusText = 'Action Required';
                    } else {
                        statusClass = 'pending-work';
                        statusText = 'Work Pending';
                    }
                } else {
                    statusClass = 'incomplete';
                    statusText = 'Incomplete Data';
                }
                
                if (entry.linkedEntries && entry.linkedEntries.length > 0) {
                    entryClass += ' linked';
                }
                
                const linkedEntriesHtml = entry.linkedEntries && entry.linkedEntries.length > 0 
                    ? `
                        <div class="entry-links">
                            <div class="entry-links-title">🔗 Linked Entries:</div>
                            ${entry.linkedEntries.map(linked => 
                                `<span class="linked-entry">${linked.type} - ${linked.subject}</span>`
                            ).join('')}
                        </div>
                    ` 
                    : '';
                
                let actionButtons = '';
                
                // Action buttons logic
                if (!entry.confirmed && entry.complete) {
                    if (entry.type === 'Outward' || (entry.type === 'Inward' && entry.actionTaken)) {
                        actionButtons += `<button class="btn btn-success btn-sm" onclick="showConfirmModal('${entry.id}')">✅ Mark Complete</button>`;
                    }
                }
                
                if (!entry.complete || (entry.type === 'Inward' && !entry.actionTaken)) {
                    actionButtons += `<button class="btn btn-warning btn-sm" onclick="editEntry('${entry.id}')">✏️ Complete Data</button>`;
                }
                
                actionButtons += `<button class="btn btn-primary btn-sm" onclick="showLinkingModal('${entry.id}')">🔗 Link</button>`;
                actionButtons += `<button class="btn btn-secondary btn-sm" onclick="viewEntryDetails('${entry.id}')">👁️ View</button>`;
                
                return `
                    <div class="entry-item ${entryClass}" data-entry-id="${entry.id}">
                        <div class="entry-header">
                            <div class="entry-title">
                                <span class="entry-number">${entryNumber}</span>
                                ${entry.subject || 'No Subject'}
                            </div>
                            <div class="entry-badges">
                                <div class="entry-type">${entry.type || 'Unknown'}</div>
                                <div class="entry-status ${statusClass}">${statusText}</div>
                                ${entry.linkedEntries && entry.linkedEntries.length > 0 ? '<div class="entry-status linked">🔗 Linked</div>' : ''}
                            </div>
                        </div>
                        <div class="entry-meta">
                            ${entry.type === 'Inward' ? 'From' : 'To'}: ${entry.person || 'Unknown'} | 
                            Date: ${entry.dateTime || 'Unknown'} | 
                            By: ${entry.user || 'Unknown'}
                            ${!entry.complete ? ' | ⚠️ Missing required fields' : ''}
                            ${entry.type === 'Inward' && entry.complete && !entry.actionTaken ? ' | 📝 Action taken required' : ''}
                            ${entry.complete && ((entry.type === 'Outward') || (entry.type === 'Inward' && entry.actionTaken)) && !entry.confirmed ? ' | 📋 Ready for physical work' : ''}
                        </div>
                        ${linkedEntriesHtml}
                        <div class="entry-actions">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = entriesHtml;
            
            const header = document.getElementById('entriesHeader');
            if (header) {
                header.textContent = `📋 Entries (${entries.length})`;
            }
        }

        // Placeholder functions for missing functionality
        function setupSearchDropdownEvents() {
          const container = document.querySelector('.search-input-container');
          const input = document.getElementById('mainSearchInput');
          const dropdown = document.getElementById('searchDropdown');
          const dropdownContent = document.getElementById('searchDropdownContent');
          
          if (!container || !input || !dropdown || !dropdownContent) {
            console.error('Search dropdown elements not found');
            return;
          }
          
          let hideTimer = null;
          let isMouseOverContainer = false;
          let isMouseOverDropdown = false;
          let selectedDropdownIndex = -1;
          let dropdownEntries = [];
          let loadingAttempts = 0;
          const maxLoadingAttempts = 3;

          function safeClearTimeout() {
            if (hideTimer) { 
              clearTimeout(hideTimer); 
              hideTimer = null; 
            }
          }             

  function showSearchDropdown() {
    console.log('Showing search dropdown...');
    safeClearTimeout();
    dropdown.classList.add('show');
    dropdown.style.display = 'block';
    
    // Load entries if not already loaded
    if (!dropdown.dataset.loaded || dropdown.dataset.loaded === 'false') {
      dropdown.dataset.loaded = 'loading';
      dropdownContent.innerHTML = '<div style="padding:12px; color:#64748b;">📋 Loading entries...</div>';
      
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        console.log('Calling backend to load entries...');
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('✅ Backend response for dropdown:', result);
            
            // FIXED: Better response validation
            if (result && result.success && result.entries && Array.isArray(result.entries)) {
              if (result.entries.length > 0) {
                populateSearchDropdown(result);
                dropdown.dataset.loaded = 'true';
              } else {
                console.warn('⚠️ Backend returned empty entries array');
                // Try fallback with current entries
                tryFallbackData();
              }
            } else {
              console.error('❌ Invalid backend response:', result);
              // Try fallback with current entries
              tryFallbackData();
            }
          })
          .withFailureHandler(function(error) {
            console.error('❌ Failed to load entries for dropdown:', error);
            // Try fallback with current entries
            tryFallbackData();
          })
          .getAllEntriesForSearch();
      } else {
        console.error('❌ Google Apps Script not available');
        // Try fallback with current entries
        tryFallbackData();
      }
    }
  }

  function tryFallbackData() {
  console.log('🔄 Trying fallback data from currentEntries...');
  
  if (window.currentEntries && Array.isArray(window.currentEntries) && window.currentEntries.length > 0) {
    console.log(`✅ Using ${window.currentEntries.length} entries from currentEntries`);
    
    const fallbackResult = {
      success: true,
      entries: window.currentEntries.slice(0, 50), // Limit to 50 for performance
      message: `Loaded ${Math.min(50, window.currentEntries.length)} entries (fallback)`
    };
    
    populateSearchDropdown(fallbackResult);
    dropdown.dataset.loaded = 'fallback';
  } else {
    console.warn('⚠️ No fallback data available');
    dropdownContent.innerHTML = `
      <div style="padding:16px; text-align: center; color:#64748b;">
        <div style="margin-bottom: 8px;">📋 No entries available</div>
        <div style="font-size: 0.875rem;">Try refreshing the page or creating some entries</div>
        <button onclick="retryDropdownLoad()" style="margin-top: 8px; padding: 4px 8px; border: 1px solid #3b82f6; background: white; color: #3b82f6; border-radius: 4px; cursor: pointer;">
          🔄 Retry
        </button>
      </div>
    `;
  }
}

function retryDropdownLoad() {
  dropdown.dataset.loaded = 'false';
  showSearchDropdown();
}

  function hideSearchDropdown() {
    safeClearTimeout();
    dropdown.classList.remove('show');
    dropdown.style.display = 'none';
    selectedDropdownIndex = -1;
    const items = dropdown.querySelectorAll('.search-dropdown-item');
    items.forEach(function(item) {
      item.classList.remove('highlighted');
    });
  }

  function scheduleHide(delay) {
    if (!delay) delay = 200;
    safeClearTimeout();
    hideTimer = setTimeout(function() {
      if (!isMouseOverContainer && !isMouseOverDropdown) {
        hideSearchDropdown();
      }
    }, delay);
  }

  // Event listeners
  container.addEventListener('mouseenter', function(e) {
    console.log('Mouse entered container');
    isMouseOverContainer = true;
    safeClearTimeout();
    showSearchDropdown();
  });

  container.addEventListener('mouseleave', function(e) {
    console.log('Mouse left container');
    isMouseOverContainer = false;
    scheduleHide(250);
  });

  dropdown.addEventListener('mouseenter', function(e) {
    isMouseOverDropdown = true;
    safeClearTimeout();
  });

  dropdown.addEventListener('mouseleave', function(e) {
    isMouseOverDropdown = false;
    scheduleHide(250);
  });

  input.addEventListener('focus', function(e) {
    console.log('Input focused');
    safeClearTimeout();
    showSearchDropdown();
  });

  input.addEventListener('blur', function(e) {
    setTimeout(function() {
      if (!isMouseOverDropdown) {
        scheduleHide(150);
      }
    }, 150);
  });

  const closeBtn = dropdown.querySelector('.search-dropdown-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      hideSearchDropdown();
    });
  }

  // Global function to populate dropdown
  window.populateSearchDropdown = function(result) {
    console.log('📋 Populating dropdown with result:', result);
    dropdown.dataset.loaded = 'true';
    
    // FIXED: Better validation
    if (!result) {
      console.error('❌ No result provided to populateSearchDropdown');
      dropdownContent.innerHTML = '<div style="padding:12px; color:#ef4444;">No data received</div>';
      return;
    }
    
    if (!result.success) {
      console.error('❌ Result indicates failure:', result);
      dropdownContent.innerHTML = '<div style="padding:12px; color:#ef4444;">Data loading failed</div>';
      return;
    }

    if (!result.entries || !Array.isArray(result.entries) || result.entries.length === 0) {
      console.warn('⚠️ No entries in result');
      dropdownContent.innerHTML = '<div style="padding:12px; color:#64748b;">No entries available</div>';
      return;
    }

    try {
      dropdownEntries = result.entries;
      const entriesToShow = result.entries.slice(0, 50); // Limit to 50 for performance
      const htmlParts = [];
      
      console.log(`📋 Rendering ${entriesToShow.length} entries in dropdown`);
      
      for (let i = 0; i < entriesToShow.length; i++) {
        const entry = entriesToShow[i];
        
        // FIXED: Ensure entry has required fields
        if (!entry || !entry.id || !entry.subject) {
          console.warn(`⚠️ Skipping invalid entry at index ${i}:`, entry);
          continue;
        }
        
        const entryNumber = entry.inwardNo || entry.outwardNo || `#${i + 1}`;
        const typeClass = (entry.type || 'unknown').toLowerCase();
        const subject = escapeHtml(entry.subject || 'No subject');
        const person = escapeHtml(entry.person || 'Unknown');
        const dateTime = escapeHtml(entry.dateTime || 'Unknown date');
        
        let statusClass = 'incomplete';
        let statusText = 'Incomplete';
        
        if (entry.confirmed) {
          statusClass = 'confirmed';
          statusText = 'Confirmed';
        } else if (entry.complete) {
          if (entry.type === 'Inward' && !entry.actionTaken) {
            statusClass = 'incomplete';
            statusText = 'Action Required';
          } else {
            statusClass = 'ready';
            statusText = 'Ready';
          }
        }
        
        const itemHtml = `
          <div class="search-dropdown-item" data-entry-id="${entry.id}" tabindex="-1">
            <div class="dropdown-item-title">
              <span class="dropdown-item-number">${entryNumber}</span>
              <span class="dropdown-item-type ${typeClass}">${entry.type || 'Unknown'}</span>
              <span style="flex: 1; margin: 0 8px;">${subject}</span>
              <span class="dropdown-item-status ${statusClass}">${statusText}</span>
            </div>
            <div class="dropdown-item-meta">
              ${entry.type === 'Inward' ? 'From' : 'To'}: ${person} • ${dateTime}
            </div>
          </div>
        `;
        
        htmlParts.push(itemHtml);
      }
      
      if (htmlParts.length === 0) {
        dropdownContent.innerHTML = '<div style="padding:12px; color:#64748b;">No valid entries to display</div>';
        return;
      }
      
      dropdownContent.innerHTML = htmlParts.join('');

      // FIXED: Re-attach event handlers after content update
      const items = dropdown.querySelectorAll('.search-dropdown-item');
      items.forEach(function(item, idx) {
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          const id = item.getAttribute('data-entry-id');
          if (id) {
            console.log('📋 Entry selected from dropdown:', id);
            selectSearchResult(id);
          }
          hideSearchDropdown();
        });
        
        item.addEventListener('mouseenter', function() {
          selectedDropdownIndex = idx;
          updateDropdownHighlight(Array.from(items));
        });
      });
      
      console.log(`✅ Successfully populated dropdown with ${htmlParts.length} entries`);
      
    } catch (error) {
      console.error('❌ Error populating dropdown:', error);
      dropdownContent.innerHTML = '<div style="padding:12px; color:#ef4444;">Error displaying entries</div>';
    }
  };


  function updateDropdownHighlight(items) {
    items.forEach(function(item, idx) {
      if (idx === selectedDropdownIndex) {
        item.classList.add('highlighted');
      } else {
        item.classList.remove('highlighted');
      }
    });
    if (selectedDropdownIndex >= 0 && items[selectedDropdownIndex]) {
      items[selectedDropdownIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

  
  console.log('Search dropdown events setup complete');
}

function updateDropdownHighlight(items) {
  items.forEach(function(item, idx) {
    if (idx === selectedDropdownIndex) {
      item.classList.add('highlighted');
    } else {
      item.classList.remove('highlighted');
    }
  });
  if (selectedDropdownIndex >= 0 && items[selectedDropdownIndex]) {
    items[selectedDropdownIndex].scrollIntoView({ block: 'nearest' });
  }
}

        function showPendingWorkNotification(count) {
            console.log(`Pending work notification: ${count}`);
        }

        function closePendingNotification() {
            const notification = document.getElementById('pendingNotification');
            if (notification) {
                notification.classList.remove('show');
            }
        }

        function performMainSearchEnhanced() {
        const searchInput = document.getElementById('mainSearchInput');
        const searchType = document.getElementById('searchType');
        const query = searchInput.value.trim();
        
        if (query.length < 1) {
            showMessage('Please enter at least 1 character to search', 'warning');
            return;
        }
        
        hideSearchDropdown();
        showMessage('Searching entries...', 'info');
        
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.success) {
                    displayEnhancedSearchResults(result.results, result.searchQuery, searchType.value);
                    showMessage(result.message, 'success');
                } else {
                    showMessage('Search error: ' + (result ? result.message : 'Unknown error'), 'error');
                    clearMainSearchEnhanced();
                }
            })
            .withFailureHandler(function(error) {
                showMessage('Search failed: ' + error.toString(), 'error');
                clearMainSearchEnhanced();
            })
            .searchEntriesWithLinkFilter(query, searchType.value, 'all');
        }

        function displayEnhancedSearchResults(results, searchQuery, searchType) {
            const container = document.getElementById('mainSearchResults');
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748b;">
                        <p>No results found for "${searchQuery}"</p>
                    </div>
                `;
                container.style.display = 'block';
                return;
            }
            
            let resultsHtml = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                        Search Results for "${searchQuery}"
                    </div>
                    <div style="font-size: 0.875rem; color: #64748b;">
                        Found ${results.length} results
                    </div>
                </div>
            `;
            
            results.forEach(entry => {
                const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
                let statusText = entry.confirmed ? 'Confirmed' : (entry.complete ? 'Ready' : 'Incomplete');
                let statusClass = entry.confirmed ? 'confirmed' : (entry.complete ? 'ready' : 'incomplete');
                
                if (entry.type === 'Inward' && entry.complete && !entry.actionTaken) {
                    statusText = 'Action Required';
                    statusClass = 'incomplete';
                }
                
                resultsHtml += `
                    <div class="search-result-item" onclick="selectSearchResult('${entry.id}')" style="margin-bottom: 8px;">
                        <div class="search-result-title">
                            <span class="dropdown-item-number">${entryNumber}</span>
                            <span class="dropdown-item-type ${entry.type.toLowerCase()}">${entry.type}</span>
                            ${entry.subject}
                            <span class="dropdown-item-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="search-result-meta">
                            ${entry.type === 'Inward' ? 'From' : 'To'}: ${entry.person} | 
                            Date: ${entry.dateTime} | 
                            Means: ${entry.means}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = resultsHtml;
            container.style.display = 'block';
        }

function selectSearchResult(entryId) {
    const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (entryElement) {
        entryElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        entryElement.style.background = '#fef3c7';
        setTimeout(() => {
            entryElement.style.background = '';
        }, 2000);
    }
    clearMainSearchEnhanced();
}

function showAllLinkedEntries() {
    showMessage('Loading all entries with links...', 'info');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                if (result.entries.length === 0) {
                    displayMainSearchResults([], 'entries with links');
                    showMessage('No linked entries found', 'info');
                } else {
                    displayLinkedEntriesHorizontally(result.entries);
                    showMessage(`Found ${result.entries.length} entries with links`, 'success');
                }
            } else {
                showMessage('Error loading linked entries: ' + (result ? result.message : 'Unknown error'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            showMessage('Failed to load linked entries: ' + error.toString(), 'error');
        })
        .getAllLinkedEntries();
}

function displayLinkedEntriesHorizontally(linkedEntries) {
    const container = document.getElementById('mainSearchResults');
    
    let resultsHtml = `
        <div style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                🔗 All Linked Entries
            </div>
            <div style="font-size: 0.875rem; color: #64748b;">
                Found ${linkedEntries.length} entries with links
            </div>
        </div>
        <div class="linked-entries-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
    `;
    
    linkedEntries.forEach(entry => {
        const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
        let statusText = 'Incomplete';
        let statusClass = 'incomplete';
        
        if (entry.confirmed) {
            statusText = 'Confirmed';
            statusClass = 'confirmed';
        } else if (entry.complete) {
            if (entry.type === 'Inward' && !entry.actionTaken) {
                statusText = 'Action Required';
                statusClass = 'incomplete';
            } else {
                statusText = 'Ready';
                statusClass = 'ready';
            }
        }
        
        resultsHtml += `
            <div class="linked-entry-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onclick="selectSearchResult('${entry.id}')">
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <span class="dropdown-item-number">${entryNumber}</span>
                    <span class="dropdown-item-type ${entry.type.toLowerCase()}">${entry.type}</span>
                    <span style="flex: 1; min-width: 0;">${entry.subject}</span>
                </div>
                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 8px;">
                    ${entry.type === 'Inward' ? 'From' : 'To'}: ${entry.person}<br>
                    Date: ${entry.dateTime}<br>
                    User: ${entry.user}
                </div>
                <div style="font-size: 0.75rem; display: flex; align-items: center; justify-content: space-between;">
                    <span class="dropdown-item-status ${statusClass}">${statusText}</span>
                    <span style="color: #3b82f6; font-weight: 500;">🔗 ${entry.linkedEntries.length} linked</span>
                </div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #f1f5f9; font-size: 0.75rem; color: #64748b;">
                    <strong>Linked to:</strong> ${entry.linkedEntries.map(linked => `${linked.type} - ${linked.subject}`).join(', ')}
                </div>
            </div>
        `;
    });
    
    resultsHtml += `</div>`;
    
    container.innerHTML = resultsHtml;
    container.style.display = 'block';
    
    // Add hover effects
    setTimeout(() => {
        const cards = container.querySelectorAll('.linked-entry-card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
            });
        });
    }, 100);
}

        function clearMainSearchEnhanced() {
            const searchInput = document.getElementById('mainSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
        }

        function hideSearchDropdown() {
            const dropdown = document.getElementById('searchDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        function showConfirmModal(entryId) {
        const entry = currentEntries.find(e => e.id === entryId);
        if (!entry) {
            showMessage('Entry not found', 'error');
            return;
        }
        
        selectedEntryForConfirmation = entry;
        const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
        
        document.getElementById('confirmEntryDetails').innerHTML = `
            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 16px;">
                <h4 style="color: #1e293b; margin-bottom: 8px;">
                    <span class="entry-number">${entryNumber}</span>
                    ${entry.type} Entry
                </h4>
                <p><strong>Subject:</strong> ${entry.subject}</p>
                <p><strong>${entry.type === 'Inward' ? 'From' : 'To'}:</strong> ${entry.person}</p>
                <p><strong>Date:</strong> ${entry.dateTime}</p>
                <p><strong>Means:</strong> ${entry.means}</p>
                ${entry.fileReference ? `<p><strong>File Reference:</strong> ${entry.fileReference}</p>` : ''}
                ${entry.actionTaken ? `<p><strong>Action Taken:</strong> ${entry.actionTaken}</p>` : ''}
            </div>
        `;
        
        document.getElementById('confirmationNote').value = '';
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        selectedEntryForConfirmation = null;
    }

    function confirmEntry() {
        if (!selectedEntryForConfirmation) {
            showMessage('No entry selected for confirmation', 'error');
            return;
        }
        
        const confirmBtn = document.getElementById('confirmBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Confirming...';
        confirmBtn.disabled = true;
        
        const confirmationNote = document.getElementById('confirmationNote').value;
        
        google.script.run
            .withSuccessHandler(function(result) {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                
                if (result && result.success) {
                    showMessage('Entry confirmed successfully!', 'success');
                    closeConfirmModal();
                    refreshDashboard();
                } else {
                    showMessage('Error confirming entry: ' + (result ? result.message : 'Unknown error'), 'error');
                }
            })
            .withFailureHandler(function(error) {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                showMessage('Error confirming entry: ' + error.toString(), 'error');
            })
            .confirmEntry(selectedEntryForConfirmation.id, confirmationNote);
    }

        function showLinkingModal(entryId) {
    const entry = currentEntries.find(e => e.id === entryId);
    if (!entry) {
        showMessage('Entry not found', 'error');
        return;
    }
    
    selectedEntryForLinking = entry;
    selectedEntriesForLinking = [];
    
    const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
    document.getElementById('currentEntryForLinking').innerHTML = `
        <h5 style="color: #1e293b; margin-bottom: 4px;">
            <span class="entry-number">${entryNumber}</span>
            ${entry.type}: ${escapeHtml(entry.subject)} //Fix_1
        </h5>
        <p style="color: #64748b; font-size: 0.875rem; margin: 0;">
            ${entry.type === 'Inward' ? 'From' : 'To'}: ${entry.person} | ${entry.dateTime}
        </p>
    `;
    
    document.getElementById('linkingSearchInput').value = '';
    loadLinkableEntries(entryId);
    document.getElementById('linkingModal').style.display = 'flex';
}

function closeLinkingModal() {
    document.getElementById('linkingModal').style.display = 'none';
    selectedEntryForLinking = null;
    selectedEntriesForLinking = [];
    allLinkableEntries = [];
    currentLinkableEntries = [];
}

function loadLinkableEntries(currentEntryId) {
    const container = document.getElementById('linkableEntries');
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Loading available entries...</div>';
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                allLinkableEntries = result.entries;
                currentLinkableEntries = [...allLinkableEntries];
                displayLinkableEntries(currentLinkableEntries);
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Error loading linkable entries</div>';
            }
        })
        .withFailureHandler(function(error) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Error loading linkable entries</div>';
        })
        .getLinkableEntries(currentEntryId);
}

function searchInLinkingModal() {
    const searchInput = document.getElementById('linkingSearchInput');
    const searchType = document.getElementById('linkingSearchType');
    const query = searchInput.value.trim().toLowerCase();
    
    if (query.length === 0) {
        currentLinkableEntries = [...allLinkableEntries];
    } else {
        currentLinkableEntries = allLinkableEntries.filter(entry => {
            const matchesType = searchType.value === 'all' || entry.type.toLowerCase() === searchType.value;
            const entryNumber = entry.inwardNo || entry.outwardNo || '';
            const matchesQuery = 
                entry.subject.toLowerCase().includes(query) ||
                entry.person.toLowerCase().includes(query) ||
                entryNumber.toLowerCase().includes(query) ||
                (entry.means && entry.means.toLowerCase().includes(query)) ||
                (entry.fileReference && entry.fileReference.toLowerCase().includes(query));
            
            return matchesType && matchesQuery;
        });
    }
    
    displayLinkableEntries(currentLinkableEntries);
    
    if (currentLinkableEntries.length === 0 && query.length > 0) {
        showMessage(`No entries found matching "${query}"`, 'info');
    }
}

function clearLinkingSearch() {
    document.getElementById('linkingSearchInput').value = '';
    document.getElementById('linkingSearchType').value = 'all';
    currentLinkableEntries = [...allLinkableEntries];
    displayLinkableEntries(currentLinkableEntries);
}

function displayLinkableEntries(entries) {
    const container = document.getElementById('linkableEntries');
    
    if (!entries || entries.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">No entries available for linking</div>';
        return;
    }
    
    const entriesHtml = entries.map(entry => {
        const isSelected = selectedEntriesForLinking.includes(entry.id);
        const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
        
        return `
            <div class="linkable-entry ${isSelected ? 'selected' : ''}" data-entry-id="${entry.id}" onclick="toggleLinkableEntry('${entry.id}')">
                <div class="linkable-entry-title">
                    <span class="dropdown-item-number">${entryNumber}</span>
                    ${entry.type}: ${entry.subject}
                </div>
                <div class="linkable-entry-meta">
                    ${entry.type === 'Inward' ? 'From' : 'To'}: ${entry.person} | ${entry.dateTime}
                    ${entry.linkedEntries && entry.linkedEntries.length > 0 ? ` | Already linked to ${entry.linkedEntries.length} entries` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = entriesHtml;
}

function toggleLinkableEntry(entryId) {
    const entryElement = document.querySelector(`[data-entry-id="${entryId}"]`);
    
    if (selectedEntriesForLinking.includes(entryId)) {
        selectedEntriesForLinking = selectedEntriesForLinking.filter(id => id !== entryId);
        entryElement.classList.remove('selected');
    } else {
        selectedEntriesForLinking.push(entryId);
        entryElement.classList.add('selected');
    }
    
    document.getElementById('linkEntriesBtn').textContent = 
        selectedEntriesForLinking.length > 0 
            ? `🔗 Link ${selectedEntriesForLinking.length} Entries` 
            : '🔗 Link Entries';
}

function linkSelectedEntries() {
    if (selectedEntriesForLinking.length === 0) {
        showMessage('Please select entries to link', 'warning');
        return;
    }
    
    const linkBtn = document.getElementById('linkEntriesBtn');
    const originalText = linkBtn.textContent;
    linkBtn.textContent = 'Linking...';
    linkBtn.disabled = true;
    
    google.script.run
        .withSuccessHandler(function(result) {
            linkBtn.textContent = originalText;
            linkBtn.disabled = false;
            
            if (result && result.success) {
                showMessage(`Successfully linked ${selectedEntriesForLinking.length} entries!`, 'success');
                if (result.uuid) {
                    console.log(`Link UUID: ${result.uuid}`);
                }
                closeLinkingModal();
                refreshDashboard();
            } else {
                showMessage('Error linking entries: ' + (result ? result.message : 'Unknown error'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            linkBtn.textContent = originalText;
            linkBtn.disabled = false;
            showMessage('Error linking entries: ' + error.toString(), 'error');
        })
        .linkEntries(selectedEntryForLinking.id, selectedEntriesForLinking);
}

       function editEntry(entryId) {
    const entry = currentEntries.find(e => e.id === entryId);
    if (!entry) {
        showMessage('Entry not found', 'error');
        return;
    }
    
    // Set entry data
    document.getElementById('editEntryId').value = entry.id;
    document.getElementById('editEntryType').value = entry.type;
    
    // Populate form fields
    populateEditForm(entry);
    toggleEditFormFields(entry.type);
    
    // Set modal title
    const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
    document.getElementById('editModalTitle').textContent = `✏️ Edit ${entry.type} Entry - ${entryNumber}`;
    
    // Show modal
    document.getElementById('editModal').style.display = 'flex';
    setupEditFormSubmission();
}

function populateEditForm(entry) {
    document.getElementById('editSubject').value = entry.subject || '';
    document.getElementById('editMeans').value = entry.means || '';
    document.getElementById('editFileReference').value = entry.fileReference || '';
    document.getElementById('editPostalTariff').value = entry.postalTariff || '';
    
    if (entry.dateTime) {
        try {
            const date = new Date(entry.dateTime);
            if (!isNaN(date.getTime())) {
                const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
                document.getElementById('editReceiptDateTime').value = localDateTime.toISOString().slice(0, 16);
            }
        } catch (error) {
            console.error('Error parsing date:', error);
        }
    }
    
    if (entry.type === 'Inward') {
        document.getElementById('editInwardNo').value = entry.inwardNo || '';
        document.getElementById('editFromWhom').value = entry.person || '';
        document.getElementById('editTakenBy').value = entry.user || '';
        document.getElementById('editActionTaken').value = entry.actionTaken || '';
    } else {
        document.getElementById('editOutwardNo').value = entry.outwardNo || '';
        document.getElementById('editToWhom').value = entry.person || '';
        document.getElementById('editSentBy').value = entry.user || '';
        document.getElementById('editDueDate').value = entry.dueDate ? entry.dueDate.split('T')[0] : '';
    }
}

function toggleEditFormFields(entryType) {
    const inwardFields = ['editInwardNoGroup', 'editFromWhomGroup', 'editTakenByGroup', 'editActionTakenGroup'];
    const outwardFields = ['editOutwardNoGroup', 'editToWhomGroup', 'editSentByGroup', 'editCaseClosedGroup', 'editDueDateGroup'];
    
    // Get label elements
    const fileRefLabel = document.getElementById('editFileRefLabel');
    const postalTariffLabel = document.getElementById('editPostalTariffLabel');
    
    if (entryType === 'Inward') {
        inwardFields.forEach(id => document.getElementById(id).style.display = 'block');
        outwardFields.forEach(id => document.getElementById(id).style.display = 'none');
        
        document.getElementById('editFromWhom').required = true;
        document.getElementById('editTakenBy').required = true;
        document.getElementById('editToWhom').required = false;
        document.getElementById('editSentBy').required = false;
        document.getElementById('editCaseClosed').required = false;
        document.getElementById('editDueDate').required = false;
        document.getElementById('editFileReference').required = false;
        document.getElementById('editPostalTariff').required = false;
        
        if (fileRefLabel) {
            fileRefLabel.innerHTML = 'File Reference';
            fileRefLabel.classList.remove('required');
        }
        if (postalTariffLabel) {
            postalTariffLabel.innerHTML = 'Postal Tariff';
            postalTariffLabel.classList.remove('required');
        }
        
    } else {
        inwardFields.forEach(id => document.getElementById(id).style.display = 'none');
        outwardFields.forEach(id => document.getElementById(id).style.display = 'block');
        
        document.getElementById('editFromWhom').required = false;
        document.getElementById('editTakenBy').required = false;
        document.getElementById('editToWhom').required = true;
        document.getElementById('editSentBy').required = true;
        document.getElementById('editCaseClosed').required = true;
        document.getElementById('editDueDate').required = true;
        document.getElementById('editFileReference').required = true;
        document.getElementById('editPostalTariff').required = true;
        
        if (fileRefLabel) {
            fileRefLabel.innerHTML = 'File Reference';
            fileRefLabel.classList.add('required');
        }
        if (postalTariffLabel) {
            postalTariffLabel.innerHTML = 'Postal Tariff';
            postalTariffLabel.classList.add('required');
        }
    }
}

function setupEditFormSubmission() {
    const form = document.getElementById('editEntryForm');
    form.onsubmit = function(e) {
        e.preventDefault();
        updateEntry();
    };
}

function updateEntry() {
    const entryId = document.getElementById('editEntryId').value;
    const entryType = document.getElementById('editEntryType').value;
    
    const updatedData = {
        id: entryId,
        type: entryType,
        receiptDateTime: document.getElementById('editReceiptDateTime').value,
        means: document.getElementById('editMeans').value,
        subject: document.getElementById('editSubject').value,
        fileReference: document.getElementById('editFileReference').value,
        postalTariff: document.getElementById('editPostalTariff').value
    };
    
    // Add type-specific fields
    if (entryType === 'Inward') {
        updatedData.fromWhom = document.getElementById('editFromWhom').value;
        updatedData.takenBy = document.getElementById('editTakenBy').value;
        updatedData.actionTaken = document.getElementById('editActionTaken').value;
        updatedData.inwardNo = document.getElementById('editInwardNo').value;
    } else {
        updatedData.toWhom = document.getElementById('editToWhom').value;
        updatedData.sentBy = document.getElementById('editSentBy').value;
        updatedData.caseClosed = document.getElementById('editCaseClosed').value;
        updatedData.outwardNo = document.getElementById('editOutwardNo').value;
        updatedData.dueDate = document.getElementById('editDueDate').value;
    }
    
    // Validate required fields
    const validation = validateFormData(updatedData, entryType);
    if (!validation.isValid) {
        showMessage(validation.message, 'error');
        return;
    }
    
    const updateBtn = document.getElementById('updateBtn');
    const originalText = updateBtn.textContent;
    updateBtn.textContent = 'Updating...';
    updateBtn.disabled = true;
    
    google.script.run
        .withSuccessHandler(function(result) {
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
            
            if (result && result.success) {
                showMessage(`${entryType} entry updated successfully!`, 'success');
                closeEditModal();
                setTimeout(() => refreshDashboard(), 1000);
            } else {
                showMessage('Error updating entry: ' + (result ? result.message : 'Unknown error'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
            showMessage('Error updating entry: ' + error.toString(), 'error');
        })
        .updateEntry(updatedData);
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function updateEntryActionTaken(entryId, actionTaken) {
    if (typeof google === 'undefined' || !google.script) {
        showMessage('Cannot update entry - Google Apps Script not available', 'error');
        return;
    }
    
    // Call your backend function to update the Action Taken field
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                showMessage('Action Taken updated successfully!', 'success');
                refreshDashboard(); // Reload entries to show updated status
            } else {
                showMessage('Error updating Action Taken: ' + (result ? result.message : 'Unknown error'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            showMessage('Error updating Action Taken: ' + error.toString(), 'error');
        })
        .updateEntryActionTaken(entryId, actionTaken);
}

        function viewEntryDetails(entryId) {
            const entry = currentEntries.find(e => e.id === entryId);
            if (entry) {
                const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
                let statusText = 'Incomplete';
                if (entry.confirmed) {
                    statusText = 'Confirmed';
                } else if (entry.complete) {
                    if (entry.type === 'Inward' && !entry.actionTaken) {
                        statusText = 'Action Required';
                    } else {
                        statusText = 'Ready to Confirm';
                    }
                }
                
                alert(`Entry Details:\n\nNumber: ${entryNumber}\nType: ${entry.type}\nSubject: ${entry.subject}\n${entry.type === 'Inward' ? 'From' : 'To'}: ${entry.person}\nDate: ${entry.dateTime}\nMeans: ${entry.means}\nStatus: ${statusText}\nLinked Entries: ${entry.linkedEntries ? entry.linkedEntries.length : 0}${entry.actionTaken ? `\nAction Taken: ${entry.actionTaken}` : ''}`);
            }
        }

        function generateReport() {
    showReportOptionsModal();
}

function showReportOptionsModal() {
    const modalHtml = `
        <div id="reportOptionsModal" class="modal" style="display: flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">📊 Generate Report</h3>
                    <button class="close-btn" onclick="closeReportOptionsModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="reportType">Report Type</label>
                    <select id="reportType">
                        <option value="summary">Summary Report</option>
                        <option value="detailed">Detailed Entries Report</option>
                        <option value="pending">Pending Work Report</option>
                        <option value="links">Linked Entries Report</option>
                        <option value="stats">Statistics Report</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reportFormat">Download Format</label>
                    <select id="reportFormat">
                        <option value="csv">CSV (Excel Compatible)</option>
                        <option value="json">JSON</option>
                        <option value="txt">Text Report</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dateFrom">From Date (Optional)</label>
                    <input type="date" id="dateFrom">
                </div>
                
                <div class="form-group">
                    <label for="dateTo">To Date (Optional)</label>
                    <input type="date" id="dateTo">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeReportOptionsModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generateSelectedReport()">📊 Generate Report</button>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('reportOptionsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
}

function closeReportOptionsModal() {
    const modal = document.getElementById('reportOptionsModal');
    if (modal) {
        modal.remove();
    }
}

function generateSelectedReport() {
    const reportType = document.getElementById('reportType').value;
    const reportFormat = document.getElementById('reportFormat').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    const reportOptions = {
        type: reportType,
        format: reportFormat,
        dateFrom: dateFrom || null,
        dateTo: dateTo || null
    };
    
    closeReportOptionsModal();
    showMessage('Generating report...', 'info');
    
    if (reportFormat === 'csv') {
        generateCSVReport(reportType, dateFrom, dateTo);
    } else {
        google.script.run
            .withSuccessHandler(function(result) {
                if (result && result.success) {
                    handleReportSuccess(result, reportOptions);
                } else {
                    showMessage('Error generating report: ' + (result ? result.message : 'Unknown error'), 'error');
                }
            })
            .withFailureHandler(function(error) {
                showMessage('Error generating report: ' + error.toString(), 'error');
            })
            .generateSystemReport(reportOptions);
    }
}

function generateCSVReport(reportType, dateFrom, dateTo) {
    let dataToReport = [...currentEntries];
    
    // Filter by date range if specified
    if (dateFrom || dateTo) {
        dataToReport = dataToReport.filter(entry => {
            const entryDate = new Date(entry.dateTime);
            if (dateFrom && entryDate < new Date(dateFrom)) return false;
            if (dateTo && entryDate > new Date(dateTo + 'T23:59:59')) return false;
            return true;
        });
    }
    
    // Filter by report type
    switch(reportType) {
        case 'pending':
            dataToReport = dataToReport.filter(entry => {
                if (entry.type === 'Inward') {
                    return entry.complete && entry.actionTaken && !entry.confirmed;
                } else {
                    return entry.complete && !entry.confirmed;
                }
            });
            break;
        case 'links':
            dataToReport = dataToReport.filter(entry => entry.linkedEntries && entry.linkedEntries.length > 0);
            break;
        case 'stats':
            generateStatsReport();
            return;
    }
    
    if (dataToReport.length === 0) {
        showMessage('No data found for the selected criteria', 'warning');
        return;
    }
    
    // Generate CSV
    const headers = ['Type', 'Number', 'Subject', 'Person', 'Date/Time', 'Means', 'User', 'Status', 'Links', 'File Reference', 'Action Taken/Case Closed'];
    const csvContent = [
        headers.join(','),
        ...dataToReport.map(entry => {
            const entryNumber = entry.inwardNo || entry.outwardNo || 'N/A';
            let status = 'Incomplete';
            if (entry.confirmed) {
                status = 'Work Complete';
            } else if (entry.complete) {
                if (entry.type === 'Inward' && !entry.actionTaken) {
                    status = 'Action Required';
                } else {
                    status = 'Work Pending';
                }
            }
            
            const linksCount = entry.linkedEntries ? entry.linkedEntries.length : 0;
            const actionOrCase = entry.actionTaken || entry.caseClosed || '';
            
            return [
                entry.type || '',
                entryNumber,
                `"${(entry.subject || '').replace(/"/g, '""')}"`,
                `"${(entry.person || '').replace(/"/g, '""')}"`,
                entry.dateTime || '',
                entry.means || '',
                entry.user || '',
                status,
                linksCount,
                `"${(entry.fileReference || '').replace(/"/g, '""')}"`,
                `"${actionOrCase.replace(/"/g, '""')}"`
            ].join(',');
        })
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${reportType}_report_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage(`${reportType.charAt(0).toUpperCase() + reportType.slice(1)} report generated successfully!`, 'success');
}

function generateStatsReport() {
    const stats = {
        totalEntries: currentEntries.length,
        inwardEntries: currentEntries.filter(e => e.type === 'Inward').length,
        outwardEntries: currentEntries.filter(e => e.type === 'Outward').length,
        completedEntries: currentEntries.filter(e => e.confirmed).length,
        pendingEntries: currentEntries.filter(e => e.complete && !e.confirmed).length,
        incompleteEntries: currentEntries.filter(e => !e.complete).length,
        linkedEntries: currentEntries.filter(e => e.linkedEntries && e.linkedEntries.length > 0).length,
        generatedAt: new Date().toLocaleString()
    };
    
    const statsText = `DOCUMENT MANAGEMENT SYSTEM - STATISTICS REPORT
Generated: ${stats.generatedAt}

OVERVIEW:
Total Entries: ${stats.totalEntries}
Inward Entries: ${stats.inwardEntries}
Outward Entries: ${stats.outwardEntries}

STATUS BREAKDOWN:
Completed (Confirmed): ${stats.completedEntries}
Pending Work: ${stats.pendingEntries}
Incomplete Data: ${stats.incompleteEntries}

LINKING:
Entries with Links: ${stats.linkedEntries}
Entries without Links: ${stats.totalEntries - stats.linkedEntries}

COMPLETION RATE:
Overall: ${((stats.completedEntries / stats.totalEntries) * 100).toFixed(1)}%
Data Completion: ${(((stats.totalEntries - stats.incompleteEntries) / stats.totalEntries) * 100).toFixed(1)}%
`;
    
    const blob = new Blob([statsText], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `statistics_report_${new Date().toISOString().split('T')[0]}.txt`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage('Statistics report generated successfully!', 'success');
}

function handleReportSuccess(result, options) {
    showMessage(`${options.type.charAt(0).toUpperCase() + options.type.slice(1)} report generated successfully!`, 'success');
}

function showFinancialReportModal() {
    const modalHtml = `
        <div id="financialReportModal" class="modal" style="display: flex;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">💰 Financial Expenditure Report</h3>
                    <button class="close-btn" onclick="closeFinancialReportModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="finReportDateFrom">From Date</label>
                    <input type="date" id="finReportDateFrom">
                </div>
                
                <div class="form-group">
                    <label for="finReportDateTo">To Date</label>
                    <input type="date" id="finReportDateTo">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFinancialReportModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generateFinancialExpenditure()">📊 Generate Report</button>
                </div>
                
                <div id="financialReportContent" style="display: none; margin-top: 20px;">
                    <!-- Report will be displayed here -->
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('financialReportModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Set default dates
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('finReportDateTo').value = today.toISOString().split('T')[0];
    document.getElementById('finReportDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
}

function closeFinancialReportModal() {
    const modal = document.getElementById('financialReportModal');
    if (modal) {
        modal.remove();
    }
}

function generateFinancialExpenditure() {
    const dateFrom = document.getElementById('finReportDateFrom').value;
    const dateTo = document.getElementById('finReportDateTo').value;
    
    showMessage('Generating financial report...', 'info');
    
    google.script.run
        .withSuccessHandler(function(result) {
            if (result && result.success) {
                displayFinancialReport(result);
                showMessage('Financial report generated successfully!', 'success');
            } else {
                showMessage('Error generating report: ' + (result ? result.message : 'Unknown error'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            showMessage('Error generating report: ' + error.toString(), 'error');
        })
        .generateFinancialReport(dateFrom, dateTo);
}

function displayFinancialReport(result) {
    const contentDiv = document.getElementById('financialReportContent');
    
    if (!result.data || result.data.length === 0) {
        contentDiv.innerHTML = '<p style="text-align: center; color: #64748b;">No outward entries found for the selected date range.</p>';
        contentDiv.style.display = 'block';
        return;
    }
    
    let tableHtml = `
        <h4 style="text-align: center; margin-bottom: 10px;">Outward Expenditure Report</h4>
        <p style="text-align: center; color: #64748b; font-size: 0.875rem;">
            Period: ${result.dateRange.from} to ${result.dateRange.to}<br>
            Generated: ${result.generatedAt}
        </p>
        
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Serial No.</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Ack Rec</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Cross No.</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Date</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">File Reference</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Address</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Particular</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Due Date</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px;">Receipt No.</th>
                        <th style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">Postal Amount</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    result.data.forEach(row => {
        tableHtml += `
            <tr>
                <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: center;">${row.serialNo}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.ackRec}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.crossNo || '-'}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.date}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.fileReference || '-'}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.address}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.particular}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.dueDate}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px;">${row.receiptNumber}</td>
                <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">₹${parseFloat(row.postalAmount).toFixed(2)}</td>
            </tr>
        `;
    });
    
    tableHtml += `
                </tbody>
                <tfoot>
                    <tr style="background: #f8fafc; font-weight: bold;">
                        <td colspan="9" style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">Total Expenditure:</td>
                        <td style="border: 1px solid #e2e8f0; padding: 8px; text-align: right;">₹${result.totalExpenditure.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-primary btn-sm" onclick="downloadFinancialReport()">💾 Download as CSV</button>
        </div>
    `;
    
    contentDiv.innerHTML = tableHtml;
    contentDiv.style.display = 'block';
    
    // Store report data for download
    window.currentFinancialReport = result;
}

function downloadFinancialReport() {
    if (!window.currentFinancialReport) {
        showMessage('No report data available', 'error');
        return;
    }
    
    const data = window.currentFinancialReport.data;
    const headers = ['Serial No', 'Ack Rec', 'Cross No', 'Date', 'File Reference', 'Address', 'Particular', 'Due Date', 'Receipt Number', 'Postal Amount'];
    
    const csvContent = [
        headers.join(','),
        ...data.map(row => [
            row.serialNo,
            `"${row.ackRec}"`,
            `"${row.crossNo}"`,
            `"${row.date}"`,
            `"${(row.fileReference || '').replace(/"/g, '""')}"`,
            `"${(row.address || '').replace(/"/g, '""')}"`,
            `"${(row.particular || '').replace(/"/g, '""')}"`,
            `"${row.dueDate}"`,
            `"${row.receiptNumber}"`,
            row.postalAmount
        ].join(',')),
        '',
        `Total Expenditure,,,,,,,,,${window.currentFinancialReport.totalExpenditure.toFixed(2)}`
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `financial_report_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage('Report downloaded successfully!', 'success');
}
        function refreshDashboard() {
            showMessage('Refreshing dashboard...', 'info');
            loadEntries();
            
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            updateDashboardStats(result.stats);
                            showMessage('Dashboard refreshed successfully', 'success');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error refreshing stats:', error);
                        showMessage('Dashboard refresh completed with warnings', 'warning');
                    })
                    .getDashboardData();
            }
        }

        function closeModal() {
            const modal = document.getElementById('entryModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function exit() {
            if (confirm('Are you sure you want to exit?')) {
                showMessage('Logging out...', 'info');
                window.location.href = 'about:blank';
            }
        }

        function showMessage(text, type = 'info') {
            console.log(`Message [${type}]: ${text}`);
            
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            
            document.body.appendChild(message);
            
            setTimeout(() => message.classList.add('show'), 100);
            
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => message.remove(), 300);
            }, 4000);
        }

        // Modal event handlers
        document.getElementById('entryModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                clearMainSearchEnhanced();
                hideSearchDropdown();
            }
        });
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) closeConfirmModal();
        });

        document.getElementById('linkingModal').addEventListener('click', function(e) {
            if (e.target === this) closeLinkingModal();
        });

        // Update the existing keydown handler
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeConfirmModal();
                closeLinkingModal();
                closeEditModal();
                clearMainSearchEnhanced();
                hideSearchDropdown();
                closeReportOptionsModal();
            }
        });
    </script>

</body>
</html>